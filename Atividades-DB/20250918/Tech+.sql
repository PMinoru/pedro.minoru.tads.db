-- ######### CRIAÇÃO DAS TABELAS #########
CREATE TABLE CLIENTES (
  ID    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  NOME  VARCHAR2(100) NOT NULL,
  EMAIL VARCHAR2(120) UNIQUE
);

CREATE TABLE PRODUTOS (
  ID     NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  NOME   VARCHAR2(100) NOT NULL,
  PRECO  NUMBER(10,2)  NOT NULL CHECK (preco >= 0),
  TIPO   VARCHAR2(50) NOT NULL
);

CREATE TABLE PEDIDOS (
  ID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  CLIENTE_ID NUMBER NOT NULL REFERENCES CLIENTES(ID),
  PRODUTO_ID NUMBER NOT NULL REFERENCES (PRODUTOS_ID),
  STATUS     VARCHAR2(20) NOT NULL CHECK (status IN ('ABERTO','FINALIZADO','CANCELADO'))
);

CREATE TABLE CLIENTES_STG (
  NOME  VARCHAR2(100) NOT NULL,
  EMAIL VARCHAR2(120) NOT NULL
);


-- ######### ADICIONANDO OS PRIMEIROS CLIENTES #########
INSERT INTO CLIENTES (NOME, EMAIL) VALUES ('Isabelli', 'isabelli@gmail.com');
INSERT INTO CLIENTES (NOME, EMAIL) VALUES ('Pedro Minoru', 'pedrominoru2@gmail.com');
INSERT INTO CLIENTES (NOME, EMAIL) VALUES ('Gabriel Topam', 'gabrieltopam@gmail.com');


-- ######### ADICIONANDO OS PREÇOS PARA FAZER A ALTERAÇÃO POSTERIORMENTE #########
-- TODOS OS PRODUTOS DO TIPO NOTEBOOK RECEBERAM UM AUMENTO DE 10%
INSERT INTO PRODUTOS (nome, preco, tipo) VALUES ('Notebook X', 3000, 'Notebook');
INSERT INTO PRODUTOS (nome, preco, tipo) VALUES ('Notebook Y', 3500, 'Notebook');
INSERT INTO PRODUTOS (nome, preco, tipo) VALUES ('Celular Z', 2000, 'Celular');

UPDATE PRODUTOS SET PRECO = PRECO * 1.10 WHERE TIPO = 'NOTEBOOK';


-- ######### ADICIONANDO OS PEDIDOS E SEUS STATUS #########
INSERT INTO PEDIDOS (CLIENTE_ID, PRODUTO_ID, status) VALUES (1, 1, 'ABERTO');
INSERT INTO PEDIDOS (CLIENTE_ID, PRODUTO_ID, status) VALUES (2, 2, 'CANCELADO');
INSERT INTO PEDIDOS (CLIENTE_ID, PRODUTO_ID, status) VALUES (3, 3, 'FINALIZADO');
INSERT INTO PEDIDOS (CLIENTE_ID, PRODUTO_ID, status) VALUES (1, 2, 'CANCELADO');


-- ######### DELETANDO OS PEDIDOS COM O STATUS DE CANCELADOS #########
DELETE FROM PEDIDOS WHERE STATUS = 'CANCELADO';


-- ######### ADICIONANDO DADOS NOS ATRIBUTOS DA TABELA CLIENTES_STG #########
INSERT INTO CLIENTES_STG (NOME, EMAIL) VALUES ('Ana P.', 'ana@techplus.com');
INSERT INTO CLIENTES_STG (NOME, EMAIL) VALUES ('Daniela Nova', 'daniela@techplus.com');


-- ######### FAZENDO AS JUNÇÕES DAS DUAS TABELAS #########
-- CASO HAJA DOIS EMAILS IGUAIS, ALTERE O NOME
MERGE INTO CLIENTES CL 
USING CLIENTES_STG CL_STG 
ON    (CL.EMAIL = CL_STG.EMAIL) 
WHEN MATCHED THEN UPDATE
  SET CL.NOME = CL_STG.NOME
WHEN NOT MATCHED THEN
INSERT (CL.NOME,CL.EMAIL) VALUES (CL_STG.NOME, CL_STG.EMAIL);
-- PREPARAÇÃO PARA O AMBIENTE DE TESTE DE CONSULTAS

CREATE TABLE CLIENTES(
    ID_CLIENTE NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    NOME       VARCHAR2(100) NOT NULL,
    CIDADE     VARCHAR2(50),
    ESTADO     VARCHAR2(2)
);

CREATE TABLE VENDAS (
    ID          NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    PRODUTO     VARCHAR2(100) NOT NULL,
    CATEGORIA   VARCHAR2(50)  NOT NULL,
    VALOR       NUMBER(10,2)  NOT NULL CHECK (valor > 0),
    DATA_VENDA  DATE          DEFAULT SYSDATE,
    VENDEDOR    VARCHAR2(100) NOT NULL,
    ID_CLIENTE  NUMBER,
    CONSTRAINT FK_CLIENTE FOREIGN KEY (ID_CLIENTE) REFERENCES CLIENTES(ID_CLIENTE)
);

INSERT INTO CLIENTES (NOME, CIDADE, ESTADO) VALUES
  ('Ana', 'São Paulo', 'SP'),
  ('Bruna', 'Campinas', 'SP'),
  ('Carlos', 'Rio de Janeiro', 'RJ'),
  ('Daniel', 'Belo Horizonte', 'MG'); -- cliente sem vendas

INSERT INTO VENDAS (PRODUTO, CATEGORIA, VALOR, DATA_VENDA, VENDEDOR, ID_CLIENTE) VALUES
  ('Notebook Dell', 'Eletrônicos', 4500.00, DATE '2025-04-01', 'Carlos', 3),
  ('Mouse Gamer', 'Acessórios', 150.00, DATE '2025-04-01', 'Ana', 1),
  ('Teclado Mecânico', 'Acessórios', 300.00, DATE '2025-04-02', 'Carlos', 3),
  ('Monitor 24"', 'Eletrônicos', 1200.00, DATE '2025-04-02', 'Bruna', 2),
  ('Fone Bluetooth', 'Acessórios', 200.00, DATE '2025-04-03', 'Ana', 1),
  ('Notebook HP', 'Eletrônicos', 4000.00, DATE '2025-04-03', 'Carlos', 3),
  ('Cabo HDMI', 'Acessórios', 80.00, DATE '2025-04-04', 'Bruna', NULL);

-------------------

-- Liste todos os clientes e seus produtos comprados (mesmo que o cliente não tenha feito compras).
SELECT
    c.NOME AS CLIENTE,
    v.PRODUTO
FROM CLIENTES c
LEFT JOIN VENDAS v
    ON c.ID_CLIENTE = v.ID_CLIENTE;

-- Mostre os produtos vendidos, exibindo “Sem Cliente” para vendas sem cadastro.
SELECT
    NVL(c.NOME, 'Sem Cliente') AS Cliente,
    v.PRODUTO
FROM CLIENTES c
RIGHT JOIN VENDAS v
    ON c.ID_CLIENTE = v.ID_CLIENTE;

-- Liste o nome e a cidade dos clientes sem nenhuma venda registrada.
SELECT 
    c.NOME,
    c.CIDADE
FROM CLIENTES c
LEFT JOIN VENDAS v
    ON c.ID_CLIENTE = v.ID_CLIENTE
WHERE v.ID IS NULL;

-- Gere um relatório consolidado com todas as cidades, exibindo a soma das vendas e indicando 0 quando não houve vendas.
SELECT
    c.CIDADE,
    NVL(SUM(v.VALOR), 0) AS QTD_VEDAS
FROM CLIENTES c
LEFT JOIN VENDAS v
    ON c.ID_CLIENTE = v.ID_CLIENTE
GROUP BY CIDADE;
